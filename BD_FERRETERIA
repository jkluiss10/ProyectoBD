--Se crea table space 
CREATE TABLESPACE FERRETERIA_LIBERTAD
DATAFILE 'D:\OracleTableSpace\FERRETERIA_LIBERTAD.DBF'
SIZE 50M;
--Se crea temporal 
CREATE TEMPORARY TABLESPACE FERRETERIA_LIBERTAD_TEMP TEMPFILE 'D:\OracleTableSpace\FERRETERIA_LIBERTAD_TEMP.DBF'
SIZE 50M;
--Se crean los roles 
CREATE ROLE ADM_FERRETERIA_BD
--Se asignan los permisos al rol 
GRANT CREATE SESSION TO ADM_FERRETERIA_BD;
GRANT CREATE ANY TABLE TO ADM_FERRETERIA_BD;
GRANT CREATE ROLE TO ADM_FERRETERIA_BD;
GRANT CREATE USER TO ADM_FERRETERIA_BD;
GRANT CREATE VIEW TO ADM_FERRETERIA_BD;
GRANT CREATE ANY INDEX TO ADM_FERRETERIA_BD;
GRANT CREATE TRIGGER TO ADM_FERRETERIA_BD;
GRANT CREATE PROCEDURE TO ADM_FERRETERIA_BD;
GRANT CREATE SEQUENCE TO ADM_FERRETERIA_BD;
--Se crea un usuario
CREATE USER ADMIN_FERRETERIA IDENTIFIED BY 123 DEFAULT TABLESPACE CLUB TEMPORARY TABLESPACE FERRETERIA_LIBERTAD_TEMP;
--Se da acceso total usuario
GRANT UNLIMITED TABLESPACE TO ADMIN_FERRETERIA;
--Se asigna rol al usuario 
GRANT ADM_FERRETERIA_BD TO ADMIN_FERRETERIA;
--CREAR TABLAS
CREATE TABLE CATEGORIA(
    IDCATEGORIA INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    NOMCATEGORIA VARCHAR2(100) NOT NULL,
    ABREVCATEGORIA CHAR(3) NOT NULL,
    ESTCATEGORIA CHAR(1)NULL,
    DESCATEGORIA VARCHAR2(100) NOT NULL
    )tablespace FERRETERIA_LIBERTAD;
    
CREATE TABLE PRODUCTO(
    IDPRODUCTO INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    NOMPRODUCTO VARCHAR2(100) NOT NULL,
    ABREVPRODUCTO CHAR(10) NOT NULL,
    ESTPRODUCTO CHAR(1)NOT NULL,
    MARCA VARCHAR(45) NOT NULL,
    PRECIO NUMBER NOT NULL,
    DESPRODUCTO VARCHAR(100) NULL,
    IDCATEGORIA INT NOT NULL,
    IDPROVEEDOR INT NOT NULL,
    DESCATEGORIA VARCHAR2(100) NOT NULL
    )tablespace FERRETERIA_LIBERTAD;

CREATE TABLE PEDIDO(
    IDPEDIDO INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    FECHAPEDIDO DATE,
    MONTO NUMBER NOT NULL,
    DESPEDIDO VARCHAR2(100) NOT NULL,
    IDEMPLEADO INT NOT NULL,
    IDCLIENTE INT NOT NULL
    )tablespace FERRETERIA_LIBERTAD;

CREATE TABLE DEPARTAMENTO(
    IDDEPARTAMENTO INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    NOMDEPARTAMENTO VARCHAR2(100) NOT NULL
    )tablespace FERRETERIA_LIBERTAD;

CREATE TABLE PROVINCIA(
    IDPROVINCIA INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    NOMPROVINCIA VARCHAR2(100) NOT NULL,
    IDDEPARTAMENTO INT NOT NULL
    )tablespace FERRETERIA_LIBERTAD;

CREATE TABLE DISTRITO(
    IDDISTRITO INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    NOMDISTRITO VARCHAR2(100) NOT NULL,
    IDPROVINCIA INT NOT NULL
    )tablespace FERRETERIA_LIBERTAD;

CREATE TABLE PERSONA(
    IDPERSONA INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    NOMBRE VARCHAR2(30) NOT NULL,
    APEPATERNO VARCHAR2(45) NOT NULL,
    APEMATERNO VARCHAR2(45) NOT NULL,
    DIRECCION VARCHAR2(60) NOT NULL,
    DNI CHAR(8) NOT NULL,
    TELEFONO VARCHAR(11) NULL,
    IDDISTRITO INT NOT NULL
    )tablespace FERRETERIA_LIBERTAD;   

CREATE TABLE CLIENTE(
    IDCLIENTE INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    IDPERSONA INT NOT NULL
    )tablespace FERRETERIA_LIBERTAD;

CREATE TABLE EMPLEADO(
    IDEMPLEADO INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    RUC CHAR(11) NOT NULL,
    CARGO VARCHAR(45) NULL,
    ESTEMPLEADO CHAR(1) NULL,
    IDTIENDA INT NOT NULL,
    IDPERSONA INT NOT NULL
    )tablespace FERRETERIA_LIBERTAD;
    
CREATE TABLE TIENDA(
    IDTIENDA INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    NOMTIENDA VARCHAR2(100) NOT NULL,
    DIRECTIENDA VARCHAR2(100) NULL
    )tablespace FERRETERIA_LIBERTAD;

CREATE TABLE PEDIDO_PRODUCTO(
  IDPRODUCTO INT NOT NULL,
  IDPEDIDO INT NOT NULL
)

ALTER TABLE PEDIDO_PRODUCTO
ADD PRIMARY KEY (IDPRODUCTO,IDPEDIDO)
GO
--SP_HELP PEDIDO_PRODUCTO

CREATE TABLE PROVEEDOR(
  IDPROVEEDOR INT NOT NULL PRIMARY KEY,
  NOMPROVEEDOR VARCHAR(45) NOT NULL,
  TELPROVEEDOR INT NOT NULL,
  ESTPROVEEDOR CHAR(1) NULL
)
GO
--SP_HELP PROVEEDOR

--MOSTRAR TODAS LAS TABLAS DE LA BASE DE DATOS
SELECT NAME FROM SYSOBJECTS WHERE TYPE='U'
GO
----------------------------------------------
-- RELACION CLAVE FORANEA
-- 6 RELACIONES:
-- PROVINCIA - DEPARTAMENTO
ALTER TABLE PROVINCIA
  ADD FOREIGN KEY(IDDEPARTAMENTO)
  REFERENCES DEPARTAMENTO
GO
-- DISTRITO - PROVINCIA
ALTER TABLE DISTRITO
  ADD FOREIGN KEY(IDPROVINCIA)
  REFERENCES PROVINCIA
GO
-- PERSONA - DISTRITO
ALTER TABLE PERSONA
  ADD FOREIGN KEY(IDDISTRITO)
  REFERENCES DISTRITO
GO
-- EMPLEADO - PERSONA
ALTER TABLE EMPLEADO
  ADD FOREIGN KEY(IDPERSONA)
  REFERENCES PERSONA
GO
-- CLIENTE - PERSONA
ALTER TABLE CLIENTE
  ADD FOREIGN KEY(IDPERSONA)
  REFERENCES PERSONA
GO
-- EMPLEADO - TIENDA
ALTER TABLE EMPLEADO
  ADD FOREIGN KEY(IDTIENDA)
  REFERENCES TIENDA
GO
-- PEDIDO - EMPLEADO
ALTER TABLE PEDIDO
  ADD FOREIGN KEY(IDEMPLEADO)
  REFERENCES EMPLEADO
GO
-- PEDIDO_PRODUCTO - PEDIDO
ALTER TABLE PEDIDO_PRODUCTO
  ADD FOREIGN KEY(IDPEDIDO)
  REFERENCES PEDIDO
GO
-- PEDIDO_PRODUCTO - PRODUCTO
ALTER TABLE PEDIDO_PRODUCTO
  ADD FOREIGN KEY(IDPRODUCTO)
  REFERENCES PRODUCTO
GO
-- PRODUCTO - CATEGORIA
ALTER TABLE PRODUCTO
  ADD FOREIGN KEY(IDCATEGORIA)
  REFERENCES CATEGORIA
GO
-- PRODUCTO - PROVEEDOR
ALTER TABLE PRODUCTO
  ADD FOREIGN KEY(IDPROVEEDOR)
  REFERENCES PROVEEDOR
GO
-- PEDIDO - CIENTE
ALTER TABLE PEDIDO
  ADD FOREIGN KEY(IDCLIENTE)
  REFERENCES CLIENTE  
GO

----------------------------------------------
--CREACION DE UNA RESTRICCION PARA DATOS UNICOS
ALTER TABLE PERSONA
  ADD CONSTRAINT U_PERSONA_DNI
  UNIQUE(DNI)
GO

ALTER TABLE EMPLEADO
  ADD CONSTRAINT U_EMPLEADO_RUC
  UNIQUE(RUC)
GO

ALTER TABLE PERSONA
  ADD CONSTRAINT U_PERSONA_TELEFONO
  UNIQUE(TELEFONO)
GO

ALTER TABLE PROVEEDOR
  ADD CONSTRAINT U_PROVEEDOR_TELFPROVEEDOR
  UNIQUE(TELPROVEEDOR)
GO

ALTER TABLE CATEGORIA
  ADD CONSTRAINT U_CATEGORIA_ABREVIATURA
  UNIQUE(ABREVCATEGORIA)
GO

--LLENAR DATOS
INSERT DEPARTAMENTO VALUES(1,'Amazonas')
INSERT DEPARTAMENTO VALUES(2,'Ancash')
INSERT DEPARTAMENTO VALUES(3,'Apurimac')
INSERT DEPARTAMENTO VALUES(4,'Arequipa')
INSERT DEPARTAMENTO VALUES(5,'Ayacucho')
INSERT DEPARTAMENTO VALUES(6,'Cajamarca')
INSERT DEPARTAMENTO VALUES(7,'Callao')
INSERT DEPARTAMENTO VALUES(8,'Cusco')
INSERT DEPARTAMENTO VALUES(9,'Huancavelica')
INSERT DEPARTAMENTO VALUES(10,'Huanuco')
INSERT DEPARTAMENTO VALUES(11,'Ica')
INSERT DEPARTAMENTO VALUES(12,'Junin')
INSERT DEPARTAMENTO VALUES(13,'La Libertad')
INSERT DEPARTAMENTO VALUES(14,'Lambayeque')
INSERT DEPARTAMENTO VALUES(15,'Lima')
INSERT DEPARTAMENTO VALUES(16,'Loreto')
INSERT DEPARTAMENTO VALUES(17,'Madre De Dios')
INSERT DEPARTAMENTO VALUES(18,'Moquegua')
INSERT DEPARTAMENTO VALUES(19,'Pasco')
INSERT DEPARTAMENTO VALUES(20,'Piura')
INSERT DEPARTAMENTO VALUES(21,'Puno')
INSERT DEPARTAMENTO VALUES(22,'San Martin')
INSERT DEPARTAMENTO VALUES(23,'Tacna')
INSERT DEPARTAMENTO VALUES(24,'Tumbes')
INSERT DEPARTAMENTO VALUES(25,'Ucayali')

INSERT PROVINCIA VALUES(1,'Lima',15)
INSERT PROVINCIA VALUES(2,'Callao',15)
INSERT PROVINCIA VALUES(3,'Canta',15)
INSERT PROVINCIA VALUES(4,'Huaral',15)
INSERT PROVINCIA VALUES(5,'Huarochirí',15)
INSERT PROVINCIA VALUES(6,'Huaura',15)
INSERT PROVINCIA VALUES(7,'Barranca',15)
INSERT PROVINCIA VALUES(8,'Oyon',15)
INSERT PROVINCIA VALUES(9,'Cañete',15)

INSERT DISTRITO VALUES(1,'Cercado de Lima',1)
INSERT DISTRITO VALUES(2,'Ate',1)
INSERT DISTRITO VALUES(3,'Barranco',1)
INSERT DISTRITO VALUES(4,'Breña',1)
INSERT DISTRITO VALUES(5,'Comas',1)
INSERT DISTRITO VALUES(6,'Chorrillos',1)
INSERT DISTRITO VALUES(7,'El Agustino',1)

INSERT PERSONA VALUES(1,'CARLOS','SEVILLA','MADRID','AV. VICUS','09545918','534-0602',5)
INSERT PERSONA VALUES(2,'JUAN','VALDES','GARCÍA','AV. ROBLES','06575920','532-0911',1)
INSERT PERSONA VALUES(3,'ROBERTO','VERTIZ','JIMENES','AV. ROSAS','29545945','555-0634',6)
INSERT PERSONA VALUES(4,'JOSÉ','ALBA','TORRES','AV. ORQUIDEAS','19235999','602-4442',5)
INSERT PERSONA VALUES(5,'VICTOR','DEL SOLAR','MARTINES','AV. TIRNIDAD','23545918','678-2060',7)
INSERT PERSONA VALUES(6,'ORLANDO','OBANDO','VELTRAN','AV. 22 DE AGOSTO','08545918','623-9898',5)

INSERT CLIENTE VALUES(1,1)
INSERT CLIENTE VALUES(2,4)
INSERT CLIENTE VALUES(3,5)

INSERT TIENDA VALUES(1,'LA LIBERTAD','AV. TUPAC AMARU')

INSERT EMPLEADO VALUES(1,'10257694734','CAJERO','A',1,2)
INSERT EMPLEADO VALUES(2,'10307430260','ADMINISTRADOR','A',1,3)
INSERT EMPLEADO VALUES(3,'10452620150','GERENTE','A',1,6)

INSERT PROVEEDOR VALUES(1,'CORDILLERA MERCANTIL',6023981,'A')
INSERT PROVEEDOR VALUES(2,'ARDILES IMPORT',6051902,'A')
INSERT PROVEEDOR VALUES(3,'JEPESA REPRESENTACIONES',5572923,'A')

INSERT CATEGORIA VALUES(1,'MANUAL','MAN','A','HERRAMIENTAS DE USO MANUAL')
INSERT CATEGORIA VALUES(2,'CARPINTERÍA','CAR','A','HERRAMIENTAS DE CARPINTERÍA Y MADERA')
INSERT CATEGORIA VALUES(3,'MÁQUINA HERRAMIENTA','MAQ','A','HERRAMIENTAS PAR MÁQUINAS')
INSERT CATEGORIA VALUES(4,'CONSTRUCCION','CON','A','PRODUCTOS PARA CONSTRUCCIÓN')
INSERT CATEGORIA VALUES(5,'TUBERÍAS','TUB','A','TUBOS Y ACCESORIOS EN GENERAL')

INSERT PEDIDO VALUES(1,GETDATE()-10,87,'SIN DESCRIPCIÓN',1,1)
INSERT PEDIDO VALUES(2,GETDATE()-10,18,'SIN DESCRIPCIÓN',1,2)
INSERT PEDIDO VALUES(3,GETDATE()-10,92,'SIN DESCRIPCIÓN',1,3)

INSERT PRODUCTO VALUES(1,'ALICATES','ALIC-001','A','BAHCO',50,' ',1,2)
INSERT PRODUCTO VALUES(2,'BROCA','BRC-023','A','IMCOINSA',15,' ',2,3)
INSERT PRODUCTO VALUES(3,'FRESA','FRE-401','A','PREZISS',18,' ',2,1)
INSERT PRODUCTO VALUES(4,'ATORNILLADORA','ATO-655','A','MAKITA',37,' ',3,3)
INSERT PRODUCTO VALUES(5,'CUCHILLA','CUCH-551','A','METALMAQ',42,' ',3,2)
INSERT PRODUCTO VALUES(6,'NIVEL','LEV-034','A','COFAN',75,' ',4,1)
INSERT PRODUCTO VALUES(7,'CODO','COD-456','A','WISKA',2,' ',4,1)

INSERT PEDIDO_PRODUCTO VALUES(1,1)
INSERT PEDIDO_PRODUCTO VALUES(4,1)
INSERT PEDIDO_PRODUCTO VALUES(3,2)
INSERT PEDIDO_PRODUCTO VALUES(7,3)
INSERT PEDIDO_PRODUCTO VALUES(6,3)
INSERT PEDIDO_PRODUCTO VALUES(2,3)

--CONSULTAS
SELECT * FROM PRODUCTO

SELECT  P.IDPEDIDO,
    P.FECHAPEDIDO,
    P.IDCLIENTE,
    A.APEPATERNO,
    'MONTO TOTAL'=SUM(M.PRECIO)
FROM PEDIDO P INNER JOIN PEDIDO_PRODUCTO E
  ON(P.IDPEDIDO=E.IDPEDIDO)INNER JOIN PRODUCTO M
  ON(E.IDPRODUCTO=M.IDPRODUCTO)INNER JOIN CLIENTE C
  ON(P.IDCLIENTE=C.IDCLIENTE)INNER JOIN PERSONA A
  ON(C.IDPERSONA=A.IDPERSONA)
GROUP BY P.IDPEDIDO,P.IDCLIENTE,A.APEPATERNO,P.FECHAPEDIDO
ORDER BY P.IDPEDIDO

SELECT  C.IDCLIENTE,
    P.NOMBRE,
    P.APEPATERNO,
    P.APEMATERNO
FROM PERSONA P INNER JOIN CLIENTE C
  ON(C.IDPERSONA=P.IDPERSONA)
ORDER BY IDCLIENTE
